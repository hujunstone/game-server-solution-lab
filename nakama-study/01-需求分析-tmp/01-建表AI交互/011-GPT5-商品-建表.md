
```sql
-- =========================
-- 1. 货物 / 商品系统
-- =========================

-- 1.1 商品品类表（米粮、杂食、布帛等）
CREATE TABLE IF NOT EXISTS trade_goods_category (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
code STRING NOT NULL UNIQUE, -- 品类编码，如 "grain"、"cloth"
name STRING NOT NULL, -- 品类名称，如 "米粮"
description STRING, -- 说明：典型商品等
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- 创建时间
updated_at TIMESTAMPTZ NOT NULL DEFAULT now() -- 更新时间
);

COMMENT ON TABLE trade_goods_category IS '商品品类表：米粮、杂食、布帛、皮货等';

COMMENT ON COLUMN trade_goods_category.code IS '品类编码，供程序使用的唯一标识';
COMMENT ON COLUMN trade_goods_category.name IS '品类名（展示用）';
COMMENT ON COLUMN trade_goods_category.description IS '品类说明：典型商品列表等';

-- 1.2 商品基础信息表（具体商品：小麦、汾酒等）
CREATE TABLE IF NOT EXISTS trade_goods (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
category_id UUID NOT NULL REFERENCES trade_goods_category (id), -- 所属品类ID
code STRING NOT NULL UNIQUE, -- 商品编码，如 "wheat"、"fenjiu"
name STRING NOT NULL, -- 商品名称：小麦、汾酒
base_price INT NOT NULL, -- 基准价（单位：文）
base_stack INT NOT NULL, -- 基础一“件”数量配置，如 30件一组
rarity FLOAT NOT NULL DEFAULT 1.0, -- 稀有度系数 Rarity（>1 表示稀有）
base_quota INT NOT NULL DEFAULT 0, -- 基础配额 BaseQuota
is_exclusive BOOL NOT NULL DEFAULT false, -- 是否专营：如茶、盐等
quality_stars INT NOT NULL DEFAULT 0, -- 品质星级：0-5
note STRING, -- 备注，如“★★★”说明等
created_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- 创建时间
updated_at TIMESTAMPTZ NOT NULL DEFAULT now() -- 更新时间
);

COMMENT ON TABLE trade_goods IS '商品基础信息表：具体商品配置（小麦、汾酒等）';

COMMENT ON COLUMN trade_goods.category_id IS '商品品类ID，外键到 trade_goods_category';
COMMENT ON COLUMN trade_goods.base_price IS '基准价格 BasePrice，单位：文';
COMMENT ON COLUMN trade_goods.base_stack IS '基础数量单位（如60文/30件中的30件）';
COMMENT ON COLUMN trade_goods.rarity IS '稀有度系数 Rarity，用于配额及价格调整';
COMMENT ON COLUMN trade_goods.base_quota IS '基础配额 BaseQuota，用于计算玩家可购/可售数量';
COMMENT ON COLUMN trade_goods.is_exclusive IS '是否专营商品（茶、盐等需要特殊权限）';
COMMENT ON COLUMN trade_goods.quality_stars IS '品质星级，用于客户端展示与价格微调';

-- 1.3 贸易点（城市 / 关隘 / 山寨）配置表
CREATE TABLE IF NOT EXISTS trade_nodes (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
code STRING NOT NULL UNIQUE, -- 节点编码，如 "taiyuan_fu"
name STRING NOT NULL, -- 节点名：太原府、大同府、云中寨
node_type STRING NOT NULL, -- 节点类型：city / pass / camp / outpost 等
development FLOAT NOT NULL DEFAULT 1.0, -- 城市发展度 Development
home_preference FLOAT NOT NULL DEFAULT 0.0, -- 本地偏好 HomePreference（对本地特产）
global_factor FLOAT NOT NULL DEFAULT 1.0, -- 全局平衡系数 GlobalFactor 缓冲器
tax_markup FLOAT NOT NULL DEFAULT 0.1, -- 税率系数 TaxMarkup（0.1=10% 税差）
refresh_interval_sec INT NOT NULL DEFAULT 900, -- 配额刷新间隔（秒），默认15分钟
note STRING, -- 备注，如“雁门关外可建商栈”
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE trade_nodes IS '贸易点表：太原府、石岭关、雁门关、大同府、云中寨等地图节点';

COMMENT ON COLUMN trade_nodes.development IS '城市发展度 Development，用于价格与配额计算';
COMMENT ON COLUMN trade_nodes.home_preference IS '本地偏好系数 HomePreference，对本地特产有溢价或折扣';
COMMENT ON COLUMN trade_nodes.global_factor IS '该节点的全局平衡系数 GlobalFactor，用于全局调节通货膨胀等';
COMMENT ON COLUMN trade_nodes.tax_markup IS '税差/税率系数 TaxMarkup，用于购入和售出价差';
COMMENT ON COLUMN trade_nodes.refresh_interval_sec IS '该节点配额刷新间隔（秒），默认 900s=15分钟';

-- 1.4 贸易点-商品配置表（哪些节点卖哪些商品）
CREATE TABLE IF NOT EXISTS trade_node_goods (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 所属贸易点ID
goods_id UUID NOT NULL REFERENCES trade_goods (id), -- 商品ID
is_enabled BOOL NOT NULL DEFAULT true, -- 是否启用该商品
local_base_price INT, -- 节点局部基准价（可覆盖 trade_goods.base_price）
local_tax_markup FLOAT, -- 节点局部税率（可覆盖 trade_nodes.tax_markup）
local_home_preference FLOAT, -- 节点针对该商品的偏好系数，覆盖 trade_nodes.home_preference
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
UNIQUE (node_id, goods_id)
);

COMMENT ON TABLE trade_node_goods IS '贸易点-商品配置：每个节点可售/可收购的商品列表';

COMMENT ON COLUMN trade_node_goods.local_base_price IS '本节点对该商品的局部基准价（为空则用全局 base_price）';
COMMENT ON COLUMN trade_node_goods.local_tax_markup IS '本节点针对该商品的局部税率，覆盖节点默认税率';
COMMENT ON COLUMN trade_node_goods.local_home_preference IS '本节点对该商品的偏好修正值';

-- 1.5 价格与配额的实时状态（可持久化，亦可只放缓存）
CREATE TABLE IF NOT EXISTS trade_node_goods_state (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 贸易点ID
goods_id UUID NOT NULL REFERENCES trade_goods (id), -- 商品ID
-- 价格计算相关状态：H_D, DemandShock, SupplyShock 等可拆或合并成 JSON
demand_shock FLOAT NOT NULL DEFAULT 1.0, -- 需求冲击系数 DemandShock
supply_shock FLOAT NOT NULL DEFAULT 1.0, -- 供给冲击系数 SupplyShock
global_factor FLOAT NOT NULL DEFAULT 1.0, -- 节点+商品的全局平衡因子，可与 trade_nodes.global_factor 叠加
sale_price INT NOT NULL, -- 当前本地售价 SalePrice（卖给玩家）
purchase_price INT NOT NULL, -- 当前本地收购价 PurchasePrice（收玩家货）
quota_total INT NOT NULL, -- 当前时间窗口的总配额 Quota
quota_used INT NOT NULL DEFAULT 0, -- 当前时间窗口已使用配额
window_start_at TIMESTAMPTZ NOT NULL, -- 当前配额窗口起始时间
window_end_at TIMESTAMPTZ NOT NULL, -- 当前配额窗口结束时间
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
UNIQUE (node_id, goods_id)
);

COMMENT ON TABLE trade_node_goods_state IS '贸易点-商品的实时价格与配额状态';

COMMENT ON COLUMN trade_node_goods_state.demand_shock IS '需求冲击系数 DemandShock，>1 表示需求暴涨';
COMMENT ON COLUMN trade_node_goods_state.supply_shock IS '供给冲击系数 SupplyShock，>1 表示供应过剩';
COMMENT ON COLUMN trade_node_goods_state.sale_price IS '当前本地对玩家的售出价 SalePrice';
COMMENT ON COLUMN trade_node_goods_state.purchase_price IS '当前本地向玩家收购价 PurchasePrice';
COMMENT ON COLUMN trade_node_goods_state.quota_total IS '当前刷新窗口内的可用配额总量';
COMMENT ON COLUMN trade_node_goods_state.quota_used IS '当前刷新窗口内已消耗配额量';
COMMENT ON COLUMN trade_node_goods_state.window_start_at IS '当前配额刷新窗口的开始时间';
COMMENT ON COLUMN trade_node_goods_state.window_end_at IS '当前配额刷新窗口的结束时间';

-- 1.6 玩家在各贸易点的声望/信誉（影响配额、价格）
CREATE TABLE IF NOT EXISTS player_trade_reputation (
player_id STRING NOT NULL, -- 玩家ID（Nakama user_id）
node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 贸易点ID
reputation FLOAT NOT NULL DEFAULT 0.0, -- 声望值 Reputation
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
PRIMARY KEY (player_id, node_id)
);

COMMENT ON TABLE player_trade_reputation IS '玩家在各贸易点的声望/信誉，影响配额及价格';

COMMENT ON COLUMN player_trade_reputation.reputation IS '玩家在该节点的声望值，用于配额公式中的 Reputation';

-- =========================
-- 2. 载具 / 商队系统（与跑商直接相关）
-- =========================

-- 2.1 载具类型表（马队、牛车等不同模板，含基础载重等）
CREATE TABLE IF NOT EXISTS caravan_vehicle_types (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
code STRING NOT NULL UNIQUE, -- 载具类型编码，如 "horse_team_basic"
name STRING NOT NULL, -- 载具名称：初始马队等
base_capacity INT NOT NULL, -- 基础载货容量（总格数或重量单位）
base_speed FLOAT NOT NULL, -- 基础速度（单位：地图单位/分钟）
damage_rate FLOAT NOT NULL DEFAULT 0.1, -- 货物损坏率（0.1=10%）
robbery_reduce FLOAT NOT NULL DEFAULT 0.0, -- 抢劫概率减免（如商号旗帜 -0.5%）
note STRING, -- 说明：比如“普通木驮”效果
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE caravan_vehicle_types IS '载具类型表：马队、木驮、商号旗帜等模板配置';

COMMENT ON COLUMN caravan_vehicle_types.base_capacity IS '基础载货容量：可根据游戏设计为格数或重量';
COMMENT ON COLUMN caravan_vehicle_types.base_speed IS '基础移动速度：单位/分钟（游戏 1 分钟=现实 1 天）';
COMMENT ON COLUMN caravan_vehicle_types.damage_rate IS '货物损坏率，0.1 表示10%损耗';
COMMENT ON COLUMN caravan_vehicle_types.robbery_reduce IS '抢劫概率减免，负数表示降低被抢几率';

-- 2.2 玩家商队表（玩家拥有的商队实例）
CREATE TABLE IF NOT EXISTS player_caravans (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 商队ID
player_id STRING NOT NULL, -- 玩家ID（Nakama user_id）
vehicle_type_id UUID NOT NULL REFERENCES caravan_vehicle_types (id), -- 当前商队载具类型
name STRING NOT NULL, -- 商队名称（客户端展示）
current_node_id UUID REFERENCES trade_nodes (id), -- 当前所在贸易点ID（若在城内）
is_travelling BOOL NOT NULL DEFAULT false, -- 是否在路上
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE player_caravans IS '玩家商队表：玩家拥有的跑商队伍实例';

COMMENT ON COLUMN player_caravans.vehicle_type_id IS '商队当前使用的载具类型';
COMMENT ON COLUMN player_caravans.current_node_id IS '当前所在的贸易点节点ID，如果在城内';

-- =========================
-- 3. 贸易路线 / 风险（跑商路径）
-- =========================

-- 3.1 贸易点之间的路段（含风险配置）
CREATE TABLE IF NOT EXISTS trade_routes (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
from_node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 起点节点ID
to_node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 终点节点ID
base_risk FLOAT NOT NULL DEFAULT 0.0, -- 基础风险概率（0~1，如 0.3=30%）
distance FLOAT NOT NULL DEFAULT 1.0, -- 路线距离，用于计算时间/消耗
note STRING, -- 描述：如“扫荡云中寨后降为 5%”
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
UNIQUE (from_node_id, to_node_id)
);

COMMENT ON TABLE trade_routes IS '贸易路线表：太原府-石岭关-雁门关-大同府等路段及基础风险';

COMMENT ON COLUMN trade_routes.base_risk IS '基础风险概率，如 0.3 表示30%被山匪/马贼拦截';
COMMENT ON COLUMN trade_routes.distance IS '路线距离，用于计算移动时间和耗损';

        
-- 3.2 贸易路线的当前风险状态（受事件影响：扫荡云中寨、建立商栈等）
CREATE TABLE IF NOT EXISTS trade_route_state (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
route_id UUID NOT NULL REFERENCES trade_routes (id), -- 路线ID
current_risk FLOAT NOT NULL, -- 当前风险概率（0~1）
modifier_source STRING, -- 修正来源说明：如 "clear_bandit_camp"、"build_outpost"
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(), -- 最近一次风险刷新时间
UNIQUE (route_id)
);

COMMENT ON TABLE trade_route_state IS '贸易路线当前风险状态表：在基础风险上叠加事件/建筑等改动';

COMMENT ON COLUMN trade_route_state.current_risk IS '当前实际风险概率（0~1），包含事件与建筑影响';
COMMENT ON COLUMN trade_route_state.modifier_source IS '当前主要风险修正来源（任务、建筑、全局事件等）';

-- 3.3 商队行程记录（用于“在路上”的状态与结算）
CREATE TABLE IF NOT EXISTS caravan_travels (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 行程ID
caravan_id UUID NOT NULL REFERENCES player_caravans (id),-- 商队ID
route_id UUID NOT NULL REFERENCES trade_routes (id), -- 所走路线ID
start_node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 实际起点（通常=route.from_node_id）
end_node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 实际终点（通常=route.to_node_id）
depart_at TIMESTAMPTZ NOT NULL, -- 出发时间
arrive_at TIMESTAMPTZ NOT NULL, -- 预计到达时间（用于定时结算）
finished BOOL NOT NULL DEFAULT false, -- 是否已完成（抵达/被拦截/中断）
result STRING, -- 结果：success / robbed / aborted 等
risk_snapshot FLOAT, -- 出发时的风险快照，用于重算/回放
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE caravan_travels IS '商队行程表：记录商队在两节点之间行进与结算的过程';

COMMENT ON COLUMN caravan_travels.result IS '行程结果：success(成功抵达)/robbed(被劫)/aborted(中断等)';
COMMENT ON COLUMN caravan_travels.risk_snapshot IS '出发时记录的路线风险值，用于后续结算与日志';

-- =========================
-- 4. 商栈 / 特殊据点（影响路线风险与贸易）
-- =========================

-- 4.1 商栈类型（前哨、重镇据点等模板）
CREATE TABLE IF NOT EXISTS outpost_types (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 主键ID
code STRING NOT NULL UNIQUE, -- 类型编码，如 "road_outpost_small"
name STRING NOT NULL, -- 名称：如“小型路边商栈”
risk_reduction FLOAT NOT NULL DEFAULT 0.1, -- 路线风险减免比例（0.1=减10%）
trade_bonus FLOAT NOT NULL DEFAULT 0.0, -- 对附近节点交易奖励系数（价格/声望等）
note STRING, -- 说明：效果、建造前置条件等
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE outpost_types IS '商栈类型表：不同规格的前哨/商栈模板配置';

COMMENT ON COLUMN outpost_types.risk_reduction IS '经过该商栈影响区域的路线风险减免比例';
COMMENT ON COLUMN outpost_types.trade_bonus IS '对附近贸易点的交易加成（价格或声望）';

-- 4.2 地图上的商栈实例（可由玩家或系统拥有）
CREATE TABLE IF NOT EXISTS outposts (
id UUID PRIMARY KEY DEFAULT gen_random_uuid(), -- 商栈ID
type_id UUID NOT NULL REFERENCES outpost_types (id), -- 商栈类型ID
owner_player_id STRING, -- 所属玩家ID（为空则为系统/NPC）
node_id UUID NOT NULL REFERENCES trade_nodes (id), -- 所在贸易点或锚点节点ID
name STRING NOT NULL, -- 商栈名称
active BOOL NOT NULL DEFAULT true, -- 是否在生效中
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE outposts IS '商栈实例表：如“雁门关外商栈”等可影响附近路线风险';

COMMENT ON COLUMN outposts.node_id IS '商栈所在或挂接的贸易节点ID';
COMMENT ON COLUMN outposts.owner_player_id IS '商栈所有者玩家ID，空表示官方/公共商栈';

-- 4.3 商栈与路线的影响关系（一栈多路、多栈同路）
CREATE TABLE IF NOT EXISTS outpost_route_effects (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),   -- 主键ID
    outpost_id      UUID NOT NULL REFERENCES outposts (id),       -- 商栈ID
    route_id        UUID NOT NULL REFERENCES trade_routes (id),   -- 受影响的路线ID
    extra_risk_reduction FLOAT NOT NULL DEFAULT 0.0,              -- 额外风险减免（可叠加到 outpost_types.risk_reduction）
    extra_trade_bonus    FLOAT NOT NULL DEFAULT 0.0,              -- 针对该路线（及两端节点）的额外交易加成
    active          BOOL  NOT NULL DEFAULT true,                  -- 是否当前生效
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (outpost_id, route_id)
);

COMMENT ON TABLE outpost_route_effects IS '商栈-路线影响关系：指定某商栈对哪些路线生效及其加成';
COMMENT ON COLUMN outpost_route_effects.extra_risk_reduction IS '该商栈对指定路线额外提供的风险减免系数';
COMMENT ON COLUMN outpost_route_effects.extra_trade_bonus    IS '该商栈对指定路线两端贸易点的额外交易加成';


-- =========================
-- 5. 山寨 / 敌对势力（影响路线风险）
-- =========================

-- 5.1 敌对据点类型（如山寨、匪窝）
CREATE TABLE IF NOT EXISTS hostile_camp_types (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),   -- 主键ID
    code            STRING NOT NULL UNIQUE,                       -- 类型编码，如 "bandit_camp"
    name            STRING NOT NULL,                              -- 名称：山寨、盗匪营地等
    base_risk_bonus FLOAT NOT NULL DEFAULT 0.2,                   -- 基础风险增加量（0.2=+20%）
    note            STRING,                                       -- 说明：包含典型配置、掉落等
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

COMMENT ON TABLE hostile_camp_types IS '敌对据点类型表：山寨、盗匪营地等模板';

COMMENT ON COLUMN hostile_camp_types.base_risk_bonus IS '该类型据点对附近路线提供的基础风险增幅';


-- 5.2 地图上的敌对据点实例（如云中寨）
CREATE TABLE IF NOT EXISTS hostile_camps (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),   -- 敌对据点ID
    type_id         UUID NOT NULL REFERENCES hostile_camp_types (id), -- 据点类型ID
    node_id         UUID NOT NULL REFERENCES

```