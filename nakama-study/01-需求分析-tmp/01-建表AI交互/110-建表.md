
CockroachDB 建表语句
> 说明：以下 SQL 采用 CockroachDB 语法，所有表与列均添加注释；如无特殊说明，时间字段默认 `now()`，与 Nakama 运行时共享同一数据库。


### 角色、技能与装备实例
```sql
CREATE TABLE IF NOT EXISTS player_character (
    character_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    name STRING NOT NULL,
    gender STRING NOT NULL,
    faction_id INT NOT NULL REFERENCES faction (faction_id),
    background_id INT NOT NULL REFERENCES background_archetype (background_id),
    reputation_level SMALLINT NOT NULL DEFAULT 0,
    reputation_points INT NOT NULL DEFAULT 0,
    level INT NOT NULL DEFAULT 1,
    xp BIGINT NOT NULL DEFAULT 0,
    status STRING NOT NULL DEFAULT 'active',
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (user_id, name)
);
COMMENT ON TABLE player_character IS '玩家角色表，对应 Nakama user 的具体角色档案';
COMMENT ON COLUMN player_character.character_id IS '角色主键';
COMMENT ON COLUMN player_character.user_id IS 'Nakama users.id';
COMMENT ON COLUMN player_character.name IS '角色姓名';
COMMENT ON COLUMN player_character.gender IS '角色性别';
COMMENT ON COLUMN player_character.faction_id IS '所属势力';
COMMENT ON COLUMN player_character.background_id IS '角色出身';
COMMENT ON COLUMN player_character.reputation_level IS '声望等级枚举 0~4';
COMMENT ON COLUMN player_character.reputation_points IS '声望数值进度';
--- todo 是否需要 角色等级
COMMENT ON COLUMN player_character.level IS '角色等级';
COMMENT ON COLUMN player_character.xp IS '经验值';
--- todo 是否应该用 small int 方便索引
COMMENT ON COLUMN player_character.status IS '角色状态（active 启用, retired 停用, banned禁用）';
COMMENT ON COLUMN player_character.created_at IS '创建时间';
COMMENT ON COLUMN player_character.updated_at IS '更新时间';

CREATE TABLE IF NOT EXISTS character_attribute (
    character_id UUID PRIMARY KEY REFERENCES player_character (character_id),
    strength SMALLINT NOT NULL,
    agility SMALLINT NOT NULL,
    constitution SMALLINT NOT NULL,
    wisdom SMALLINT NOT NULL,
    hp_current INT NOT NULL,
    hp_max INT NOT NULL,
    defense INT NOT NULL,
    melee_damage_base INT NOT NULL,
    ranged_damage_base INT NOT NULL,
    load_capacity INT NOT NULL,
    last_calculated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE character_attribute IS '角色属性与派生战斗数值';
COMMENT ON COLUMN character_attribute.character_id IS '角色ID';
COMMENT ON COLUMN character_attribute.strength IS '力量';
COMMENT ON COLUMN character_attribute.agility IS '敏捷';
COMMENT ON COLUMN character_attribute.constitution IS '体质';
COMMENT ON COLUMN character_attribute.wisdom IS '智慧';
COMMENT ON COLUMN character_attribute.hp_current IS '当前生命值';
COMMENT ON COLUMN character_attribute.hp_max IS '最大生命值';
COMMENT ON COLUMN character_attribute.defense IS '防御值';
COMMENT ON COLUMN character_attribute.melee_damage_base IS '近战基础伤害';
COMMENT ON COLUMN character_attribute.ranged_damage_base IS '远程基础伤害';
COMMENT ON COLUMN character_attribute.load_capacity IS '商队负载基础值';
COMMENT ON COLUMN character_attribute.last_calculated_at IS '数值最后刷新时间';

CREATE TABLE IF NOT EXISTS character_skill (
    character_skill_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES player_character (character_id),
    skill_id INT NOT NULL REFERENCES skill_definition (skill_id),
    current_level SMALLINT NOT NULL DEFAULT 0,
    experience INT NOT NULL DEFAULT 0,
    cooldown_ready_at TIMESTAMPTZ NULL,
    UNIQUE (character_id, skill_id)
);
COMMENT ON TABLE character_skill IS '角色技能等级与冷却状态';
COMMENT ON COLUMN character_skill.character_skill_id IS '角色技能关联主键';
COMMENT ON COLUMN character_skill.character_id IS '角色ID';
COMMENT ON COLUMN character_skill.skill_id IS '技能ID';
COMMENT ON COLUMN character_skill.current_level IS '当前技能等级';
COMMENT ON COLUMN character_skill.experience IS '技能熟练度';
COMMENT ON COLUMN character_skill.cooldown_ready_at IS '冷却结束时间（若有）';

CREATE TABLE IF NOT EXISTS character_item (
    character_item_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES player_character (character_id),
    item_template_id UUID NOT NULL REFERENCES item_template (item_template_id),
    slot_code STRING NULL,
    is_equipped BOOL NOT NULL DEFAULT false,
    durability_current SMALLINT NULL,
    durability_max SMALLINT NULL,
    acquired_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    metadata JSONB NULL
);
COMMENT ON TABLE character_item IS '角色背包 / 装备实例';
COMMENT ON COLUMN character_item.character_item_id IS '实例主键';
COMMENT ON COLUMN character_item.character_id IS '所属角色';
COMMENT ON COLUMN character_item.item_template_id IS '对应装备模板';
COMMENT ON COLUMN character_item.slot_code IS '实际装备槽位';
COMMENT ON COLUMN character_item.is_equipped IS '是否装备中';
COMMENT ON COLUMN character_item.durability_current IS '当前耐久';
COMMENT ON COLUMN character_item.durability_max IS '最大耐久';
COMMENT ON COLUMN character_item.acquired_at IS '获取时间';
COMMENT ON COLUMN character_item.metadata IS '附加属性或随机词缀';


```

团队npc队员与招募
```sql
-- NPC 队员模板与招募配置 -------------------------------------
CREATE TABLE IF NOT EXISTS crew_member (
    crew_member_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES player_character (character_id),
    role_code STRING NOT NULL,
    name STRING NOT NULL,
    rarity STRING NOT NULL,
    wage INT NOT NULL,
    morale SMALLINT NOT NULL DEFAULT 100,
    status STRING NOT NULL DEFAULT 'idle',
    skill_payload JSONB NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE crew_member IS '商队成员/伙伴（护卫、账房等）';
COMMENT ON COLUMN crew_member.crew_member_id IS '成员主键';
COMMENT ON COLUMN crew_member.character_id IS '所属玩家角色';
COMMENT ON COLUMN crew_member.role_code IS '职业编码：guard/accountant/doctor/guide/porter/custodian';
COMMENT ON COLUMN crew_member.name IS '成员名称';
COMMENT ON COLUMN crew_member.rarity IS '成员品阶';
COMMENT ON COLUMN crew_member.wage IS '雇佣花费（两）';
COMMENT ON COLUMN crew_member.morale IS '士气，影响自动行为';
COMMENT ON COLUMN crew_member.status IS '状态（idle/on_mission/injured）';
COMMENT ON COLUMN crew_member.skill_payload IS '成员技能 JSON（如自动治疗逻辑）';
COMMENT ON COLUMN crew_member.created_at IS '招募时间';

CREATE TABLE IF NOT EXISTS crew_template (
    crew_template_id SERIAL PRIMARY KEY,
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    role_code STRING NOT NULL,
    base_strength SMALLINT NOT NULL,
    base_agility SMALLINT NOT NULL,
    base_constitution SMALLINT NOT NULL,
    base_wisdom SMALLINT NOT NULL,
    base_wage INT NOT NULL,
    rarity STRING NOT NULL,
    skill_payload JSONB NULL,
    description STRING NULL
);
COMMENT ON TABLE crew_template IS '可招募/初始队员的静态模板配置';
COMMENT ON COLUMN crew_template.crew_template_id IS '队员模板主键';
COMMENT ON COLUMN crew_template.code IS '模板编码，例如 ACCOUNTANT_SU_MINGYUAN';
COMMENT ON COLUMN crew_template.name IS 'NPC 显示名称';
COMMENT ON COLUMN crew_template.role_code IS '职业编码：guard/accountant/doctor/guide/porter/custodian';
COMMENT ON COLUMN crew_template.base_strength IS '基础力量';
COMMENT ON COLUMN crew_template.base_agility IS '基础敏捷';
COMMENT ON COLUMN crew_template.base_constitution IS '基础体质';
COMMENT ON COLUMN crew_template.base_wisdom IS '基础智慧';
COMMENT ON COLUMN crew_template.base_wage IS '基础工资（两）';
COMMENT ON COLUMN crew_template.rarity IS '品阶/稀有度，如 common/rare/epic';
COMMENT ON COLUMN crew_template.skill_payload IS '预设技能与特性 JSON';
COMMENT ON COLUMN crew_template.description IS '队员背景或数值说明';

CREATE TABLE IF NOT EXISTS background_starting_crew (
    background_id INT NOT NULL REFERENCES background_archetype (background_id),
    crew_template_id INT NOT NULL REFERENCES crew_template (crew_template_id),
    slot_index SMALLINT NOT NULL,
    PRIMARY KEY (background_id, slot_index)
);
COMMENT ON TABLE background_starting_crew IS '出身对应的初始队员配置';
COMMENT ON COLUMN background_starting_crew.background_id IS '角色出身 ID';
COMMENT ON COLUMN background_starting_crew.crew_template_id IS '初始队员模板 ID';
COMMENT ON COLUMN background_starting_crew.slot_index IS '初始队伍中位置（1-5）';

CREATE TABLE IF NOT EXISTS crew_recruit_pool (
    trade_node_id UUID NOT NULL REFERENCES trade_node (trade_node_id),
    crew_template_id INT NOT NULL REFERENCES crew_template (crew_template_id),
    min_reputation INT NOT NULL,
    max_reputation INT NULL,
    spawn_weight INT NOT NULL,
    PRIMARY KEY (trade_node_id, crew_template_id)
);
COMMENT ON TABLE crew_recruit_pool IS '各招募点可招募队员的候选池配置';
COMMENT ON COLUMN crew_recruit_pool.trade_node_id IS '招募点所在贸易节点';
COMMENT ON COLUMN crew_recruit_pool.crew_template_id IS '可出现的队员模板 ID';
COMMENT ON COLUMN crew_recruit_pool.min_reputation IS '最低声望要求';
COMMENT ON COLUMN crew_recruit_pool.max_reputation IS '最高声望要求，为空表示无限制';
COMMENT ON COLUMN crew_recruit_pool.spawn_weight IS '随机出现权重';
```


### 静态配置（势力、出身、技能）
```sql
CREATE TABLE IF NOT EXISTS faction (
    faction_id SERIAL PRIMARY KEY,
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    badge_icon STRING NULL,
    description STRING NULL
);
COMMENT ON TABLE faction IS '势力信息，控制声望链路，Demo阶段主要为晋商';
COMMENT ON COLUMN faction.faction_id IS '势力主键';
COMMENT ON COLUMN faction.code IS '唯一势力编码，例如 JINSHANG 供服务端与客户端对齐';
COMMENT ON COLUMN faction.name IS '势力名称';
COMMENT ON COLUMN faction.badge_icon IS '势力徽记资源引用';
COMMENT ON COLUMN faction.description IS '势力说明文本';

CREATE TABLE IF NOT EXISTS background_archetype (
    background_id SERIAL PRIMARY KEY,
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    default_strength SMALLINT NOT NULL,
    default_agility SMALLINT NOT NULL,
    default_constitution SMALLINT NOT NULL,
    default_wisdom SMALLINT NOT NULL,
    starting_companion STRING NULL,
    notes STRING NULL
);
COMMENT ON TABLE background_archetype IS '角色出身配置，决定初始属性与伙伴';
COMMENT ON COLUMN background_archetype.background_id IS '出身主键';
COMMENT ON COLUMN background_archetype.code IS '唯一出身编码，例如 FAILED_SCHOLAR';
COMMENT ON COLUMN background_archetype.name IS '出身名称';
COMMENT ON COLUMN background_archetype.default_strength IS '初始力量';
COMMENT ON COLUMN background_archetype.default_agility IS '初始敏捷';
COMMENT ON COLUMN background_archetype.default_constitution IS '初始体质';
COMMENT ON COLUMN background_archetype.default_wisdom IS '初始智慧';
COMMENT ON COLUMN background_archetype.starting_companion IS '默认团队成员编码';
COMMENT ON COLUMN background_archetype.notes IS '补充说明';

CREATE TABLE IF NOT EXISTS skill_tree (
    skill_tree_id SERIAL PRIMARY KEY,
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    description STRING NULL
);
COMMENT ON TABLE skill_tree IS '技能树定义，涵盖商贾之道、防卫之术等';
COMMENT ON COLUMN skill_tree.skill_tree_id IS '技能树主键';
COMMENT ON COLUMN skill_tree.code IS '技能树编码，如 MERCHANT_PATH';
COMMENT ON COLUMN skill_tree.name IS '技能树名称';
COMMENT ON COLUMN skill_tree.description IS '技能树描述';

CREATE TABLE IF NOT EXISTS skill_definition (
    skill_id SERIAL PRIMARY KEY,
    skill_tree_id INT NOT NULL REFERENCES skill_tree (skill_tree_id),
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    skill_type STRING NOT NULL CHECK (skill_type IN ('active','passive')),
    max_level SMALLINT NOT NULL DEFAULT 10,
    cooldown_turns SMALLINT NULL,
    base_formula JSONB NOT NULL,
    extra_effect JSONB NULL,
    unlock_requirements JSONB NULL
);
COMMENT ON TABLE skill_definition IS '技能定义，包含公式、冷却与额外效果';
COMMENT ON COLUMN skill_definition.skill_id IS '技能主键';
COMMENT ON COLUMN skill_definition.skill_tree_id IS '所属技能树';
COMMENT ON COLUMN skill_definition.code IS '技能编码，例如 IDENTIFY_GOODS';
COMMENT ON COLUMN skill_definition.name IS '技能名称';
COMMENT ON COLUMN skill_definition.skill_type IS '技能类型，active 或 passive';
COMMENT ON COLUMN skill_definition.max_level IS '技能最大等级';
COMMENT ON COLUMN skill_definition.cooldown_turns IS '技能冷却回合';
COMMENT ON COLUMN skill_definition.base_formula IS '基础公式，JSON 表示数值模型';
COMMENT ON COLUMN skill_definition.extra_effect IS '附加效果配置';
COMMENT ON COLUMN skill_definition.unlock_requirements IS '解锁条件（如品阶/任务）';

CREATE TABLE IF NOT EXISTS item_template (
    item_template_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    slot_code STRING NOT NULL,
    quality STRING NOT NULL,
    rarity SMALLINT NOT NULL,
    base_damage SMALLINT NULL,
    attribute_bonus JSONB NULL,
    special_effects JSONB NULL,
    description STRING NULL
);
COMMENT ON TABLE item_template IS '装备模板，定义槽位、品质与属性加成';
COMMENT ON COLUMN item_template.item_template_id IS '装备模板主键';
COMMENT ON COLUMN item_template.code IS '装备编号';
COMMENT ON COLUMN item_template.name IS '装备名称';
COMMENT ON COLUMN item_template.slot_code IS '槽位编码，示例：torso/head/shoes/weapon';
COMMENT ON COLUMN item_template.quality IS '品质（白/绿/蓝/紫/橙）';
COMMENT ON COLUMN item_template.rarity IS '稀有度权重';
COMMENT ON COLUMN item_template.base_damage IS '基础伤害或加成';
COMMENT ON COLUMN item_template.attribute_bonus IS '属性增益 JSON 描述';
COMMENT ON COLUMN item_template.special_effects IS '特效 JSON 描述';
COMMENT ON COLUMN item_template.description IS '装备描述';



```

# 商品与贸易节点
```sql
CREATE TABLE IF NOT EXISTS trade_good_category (
    category_id SERIAL PRIMARY KEY,
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    description STRING NULL
);
COMMENT ON TABLE trade_good_category IS '商品品类配置，例如布帛、皮货';
COMMENT ON COLUMN trade_good_category.category_id IS '品类主键';
COMMENT ON COLUMN trade_good_category.code IS '品类编码';
COMMENT ON COLUMN trade_good_category.name IS '品类名称';
COMMENT ON COLUMN trade_good_category.description IS '品类描述';

CREATE TABLE IF NOT EXISTS trade_good (
    trade_good_id SERIAL PRIMARY KEY,
    category_id INT NOT NULL REFERENCES trade_good_category (category_id),
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    base_price INT NOT NULL,
    rarity SMALLINT NOT NULL,
    base_quota INT NOT NULL,
    unit_size SMALLINT NOT NULL,
    weight_per_unit SMALLINT NOT NULL,
    notes STRING NULL
);
COMMENT ON TABLE trade_good IS '具体商品配置，含基准价与配额';
COMMENT ON COLUMN trade_good.trade_good_id IS '商品主键';
COMMENT ON COLUMN trade_good.category_id IS '所属品类';
COMMENT ON COLUMN trade_good.code IS '商品编码';
COMMENT ON COLUMN trade_good.name IS '商品名称';
COMMENT ON COLUMN trade_good.base_price IS '基准价格（文）';
COMMENT ON COLUMN trade_good.rarity IS '稀有度（1~5星）';
COMMENT ON COLUMN trade_good.base_quota IS '基础配额（件）';
COMMENT ON COLUMN trade_good.unit_size IS '单位件数';
COMMENT ON COLUMN trade_good.weight_per_unit IS '单位重量';
COMMENT ON COLUMN trade_good.notes IS '补充说明';

CREATE TABLE IF NOT EXISTS trade_node (
    trade_node_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code STRING NOT NULL UNIQUE,
    name STRING NOT NULL,
    node_type STRING NOT NULL,
    region STRING NOT NULL,
    faction_id INT NULL REFERENCES faction (faction_id),
    development_level SMALLINT NOT NULL,
    base_risk SMALLINT NOT NULL,
    description STRING NULL
);
COMMENT ON TABLE trade_node IS '贸易节点（城市、关口、山寨）配置';
COMMENT ON COLUMN trade_node.trade_node_id IS '贸易节点主键';
COMMENT ON COLUMN trade_node.code IS '节点编码，例如 TAIYUAN府';
COMMENT ON COLUMN trade_node.name IS '节点名称';
---- type 也应该是数字吧 枚举写在代码里
COMMENT ON COLUMN trade_node.node_type IS '节点类型：city/pass/stronghold';
COMMENT ON COLUMN trade_node.region IS '所属区域或路线段';
COMMENT ON COLUMN trade_node.faction_id IS '控制势力';
COMMENT ON COLUMN trade_node.development_level IS '城市发展度';
COMMENT ON COLUMN trade_node.base_risk IS '基础风险百分比';
COMMENT ON COLUMN trade_node.description IS '节点描述';

CREATE TABLE IF NOT EXISTS trade_node_stock (
    trade_node_id UUID NOT NULL REFERENCES trade_node (trade_node_id),
    trade_good_id INT NOT NULL REFERENCES trade_good (trade_good_id),
    home_preference DECIMAL(5,2) NOT NULL,
    tax_markup DECIMAL(5,2) NOT NULL,
    base_quota INT NOT NULL,
    rarity_modifier DECIMAL(5,2) NOT NULL,
    PRIMARY KEY (trade_node_id, trade_good_id)
);
COMMENT ON TABLE trade_node_stock IS '贸易节点可售商品配置，含偏好系数';
COMMENT ON COLUMN trade_node_stock.trade_node_id IS '贸易节点ID';
COMMENT ON COLUMN trade_node_stock.trade_good_id IS '商品ID';
COMMENT ON COLUMN trade_node_stock.home_preference IS '本地偏好系数 HomePreference';
COMMENT ON COLUMN trade_node_stock.tax_markup IS '税率差分 Markup';
COMMENT ON COLUMN trade_node_stock.base_quota IS '节点基础配额';
COMMENT ON COLUMN trade_node_stock.rarity_modifier IS '稀有度修正';
```

### 4.3 商队运行与价格刷新
```sql
CREATE TABLE IF NOT EXISTS caravan (
                                       caravan_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    character_id UUID NOT NULL REFERENCES player_character (character_id),
    name STRING NOT NULL,
    speed SMALLINT NOT NULL,
    cargo_capacity INT NOT NULL,
    risk_modifier DECIMAL(5,2) NOT NULL DEFAULT 0,
    current_node_id UUID NULL REFERENCES trade_node (trade_node_id),
    target_node_id UUID NULL REFERENCES trade_node (trade_node_id),
    auto_nav_enabled BOOL NOT NULL DEFAULT false,
    status STRING NOT NULL DEFAULT 'idle',
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

COMMENT ON TABLE caravan IS '商队主体，描述载具/旗帜等能力值';
COMMENT ON COLUMN caravan.caravan_id IS '商队主键';
COMMENT ON COLUMN caravan.character_id IS '所属角色';
COMMENT ON COLUMN caravan.name IS '商队名称';
COMMENT ON COLUMN caravan.speed IS '行进速度（格/分钟）';
COMMENT ON COLUMN caravan.cargo_capacity IS '载货上限';
COMMENT ON COLUMN caravan.risk_modifier IS '风险修正（阵型/旗帜影响）';
COMMENT ON COLUMN caravan.current_node_id IS '当前所在节点';
COMMENT ON COLUMN caravan.target_node_id IS '自动寻路目标节点';
COMMENT ON COLUMN caravan.auto_nav_enabled IS '是否开启自动寻路';
COMMENT ON COLUMN caravan.status IS '状态：idle/traveling/battle';
COMMENT ON COLUMN caravan.updated_at IS '最近变更时间';

CREATE TABLE IF NOT EXISTS caravan_cargo (
    caravan_cargo_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    caravan_id UUID NOT NULL REFERENCES caravan (caravan_id),
    trade_good_id INT NOT NULL REFERENCES trade_good (trade_good_id),
    quantity INT NOT NULL,
    unit_cost INT NOT NULL,
    origin_node_id UUID NOT NULL REFERENCES trade_node (trade_node_id),
    acquired_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
COMMENT ON TABLE caravan_cargo IS '商队当前货物清单';
COMMENT ON COLUMN caravan_cargo.caravan_cargo_id IS '货物项主键';
COMMENT ON COLUMN caravan_cargo.caravan_id IS '所属商队';
COMMENT ON COLUMN caravan_cargo.trade_good_id IS '商品ID';
COMMENT ON COLUMN caravan_cargo.quantity IS '数量（件）';
COMMENT ON COLUMN caravan_cargo.unit_cost IS '单件成本';
COMMENT ON COLUMN caravan_cargo.origin_node_id IS '购入节点';
COMMENT ON COLUMN caravan_cargo.acquired_at IS '购入时间';

CREATE TABLE IF NOT EXISTS market_price_snapshot (
    snapshot_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    trade_node_id UUID NOT NULL REFERENCES trade_node (trade_node_id),
    trade_good_id INT NOT NULL REFERENCES trade_good (trade_good_id),
    sale_price INT NOT NULL,
    purchase_price INT NOT NULL,
    quota_remaining INT NOT NULL,
    demand_shock DECIMAL(6,3) NOT NULL,
    supply_shock DECIMAL(6,3) NOT NULL,
    global_factor DECIMAL(6,3) NOT NULL,
    refresh_at TIMESTAMPTZ NOT NULL,
    UNIQUE (trade_node_id, trade_good_id, refresh_at)
);
COMMENT ON TABLE market_price_snapshot IS '定时刷新后的节点价格与配额';
COMMENT ON COLUMN market_price_snapshot.snapshot_id IS '快照主键';
COMMENT ON COLUMN market_price_snapshot.trade_node_id IS '节点ID';
COMMENT ON COLUMN market_price_snapshot.trade_good_id IS '商品ID';
COMMENT ON COLUMN market_price_snapshot.sale_price IS '本地售价';
COMMENT ON COLUMN market_price_snapshot.purchase_price IS '本地收购价';
COMMENT ON COLUMN market_price_snapshot.quota_remaining IS '剩余配额';
COMMENT ON COLUMN market_price_snapshot.demand_shock IS '需求波动系数';
COMMENT ON COLUMN market_price_snapshot.supply_shock IS '供给波动系数';
COMMENT ON COLUMN market_price_snapshot.global_factor IS '全局平衡因子';
COMMENT ON COLUMN market_price_snapshot.refresh_at IS '刷新时间戳';
```

### 4.4 战斗遭遇与动作日志
```sql
CREATE TABLE IF NOT EXISTS battle_encounter (
    encounter_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    caravan_id UUID NOT NULL REFERENCES caravan (caravan_id),
    encounter_type STRING NOT NULL,
    route_segment_code STRING NOT NULL,
    enemy_group_code STRING NOT NULL,
    formation_code STRING NULL,
    tactic_code STRING NULL,
    status STRING NOT NULL,
    started_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    ended_at TIMESTAMPTZ NULL,
    result_payload JSONB NULL,
    current_state_snapshot JSONB NULL
);
COMMENT ON TABLE battle_encounter IS '商队与敌对势力的战斗实例';
COMMENT ON COLUMN battle_encounter.encounter_id IS '战斗主键';
COMMENT ON COLUMN battle_encounter.caravan_id IS '涉及的商队';
COMMENT ON COLUMN battle_encounter.encounter_type IS '遭遇类型：ambush/siege/event';
COMMENT ON COLUMN battle_encounter.route_segment_code IS '所处路线段（如 TAIYUAN_SHILING）';
COMMENT ON COLUMN battle_encounter.enemy_group_code IS '敌对组合（流民、山匪、马贼）';
COMMENT ON COLUMN battle_encounter.formation_code IS '玩家选择的阵型';
COMMENT ON COLUMN battle_encounter.tactic_code IS '战术指令，如集中火力';
COMMENT ON COLUMN battle_encounter.status IS '状态：pending/active/finished';
COMMENT ON COLUMN battle_encounter.started_at IS '开战时间';
COMMENT ON COLUMN battle_encounter.ended_at IS '结束时间';
COMMENT ON COLUMN battle_encounter.result_payload IS '战斗结果 JSON（掉落、伤害统计）';
COMMENT ON COLUMN battle_encounter.current_state_snapshot IS '断线重连/回合恢复快照';

CREATE TABLE IF NOT EXISTS battle_action_log (
                                                 action_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    encounter_id UUID NOT NULL REFERENCES battle_encounter (encounter_id),
    turn_number SMALLINT NOT NULL,
    actor_ref STRING NOT NULL,
    target_ref STRING NULL,
    action_type STRING NOT NULL,
    skill_id INT NULL REFERENCES skill_definition (skill_id),
    damage_dealt INT NULL,
    effect_payload JSONB NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

COMMENT ON TABLE battle_action_log IS '战斗回合动作记录';
COMMENT ON COLUMN battle_action_log.action_id IS '动作主键';
COMMENT ON COLUMN battle_action_log.encounter_id IS '所属战斗';
COMMENT ON COLUMN battle_action_log.turn_number IS '回合序号';
COMMENT ON COLUMN battle_action_log.actor_ref IS '执行者引用（角色/成员/敌人）';
COMMENT ON COLUMN battle_action_log.target_ref IS '目标引用';
COMMENT ON COLUMN battle_action_log.action_type IS '动作类型：attack/skill/item/tactic';
COMMENT ON COLUMN battle_action_log.skill_id IS '相关技能';
COMMENT ON COLUMN battle_action_log.damage_dealt IS '造成伤害';
COMMENT ON COLUMN battle_action_log.effect_payload IS '附加效果 JSON';
COMMENT ON COLUMN battle_action_log.created_at IS '记录时间';

CREATE TABLE IF NOT EXISTS monster_template (
                                                monster_template_id SERIAL PRIMARY KEY,
                                                code STRING NOT NULL UNIQUE,
                                                name STRING NOT NULL,
                                                type STRING NOT NULL,
                                                strength SMALLINT NOT NULL,
                                                agility SMALLINT NOT NULL,
                                                constitution SMALLINT NOT NULL,
                                                wisdom SMALLINT NOT NULL,
                                                hp_max INT NOT NULL,
                                                defense INT NOT NULL,
                                                damage_base INT NOT NULL,
                                                drop_table JSONB NULL,
                                                ai_behavior STRING NULL
);

COMMENT ON TABLE monster_template IS 'NPC敌人基础属性模板';
COMMENT ON COLUMN monster_template.monster_template_id IS '怪物主键';
COMMENT ON COLUMN monster_template.code IS '怪物唯一编码';
COMMENT ON COLUMN monster_template.name IS '显示名称';
COMMENT ON COLUMN monster_template.type IS '类型：bandit/refugee/horse_thief';
COMMENT ON COLUMN monster_template.strength IS '基础力量';
COMMENT ON COLUMN monster_template.agility IS '基础敏捷';
COMMENT ON COLUMN monster_template.constitution IS '基础体质';
COMMENT ON COLUMN monster_template.wisdom IS '基础智慧';
COMMENT ON COLUMN monster_template.hp_max IS '最大生命值';
COMMENT ON COLUMN monster_template.defense IS '防御力';
COMMENT ON COLUMN monster_template.damage_base IS '基础伤害';
COMMENT ON COLUMN monster_template.drop_table IS '掉落规则JSON';
COMMENT ON COLUMN monster_template.ai_behavior IS 'AI行为逻辑编码';

```

---

### 后续对接建议
- **迁移管理**：推荐使用 Goose / Atlas 等迁移工具，将上述 SQL 切分为多条迁移脚本，便于版本回滚与测试。
- **Nakama Runtime**：Go 运行时可在 `InitModule` 中预加载 `skill_definition`、`trade_node_stock` 等静态表，改动后通过 `storage_write` 推送缓存失效消息。
- **索引与分区**：随着日志量增大，可为 `market_price_snapshot.trade_node_id`、`battle_action_log.encounter_id` 增加二级索引；战斗及日志表可按 `started_at` 进行时间分区。
- **多语言/本地化**：若后续需多语言展示，可将 `name`/`description` 拆到 `*_locale` 附表，当前阶段保持简化。




