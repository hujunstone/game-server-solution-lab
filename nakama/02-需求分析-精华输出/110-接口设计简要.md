# Nakama Demo（UE 客户端 + Go/Nakama 服务端）接口设计简要

## 1. 背景与目标
- 角色、战斗、跑商是 Demo 的三大核心系统，玩家围绕角色属性、技能、装备与商队运营展开玩法，具体数值见原始需求文档。  
```60:88:nakama/01-需求分析-tmp/001-原始需求文档.md
| 核心属性 | 初始值 | 主要影响 |
| **力量** | 10 | 近战伤害、防御 |
| **敏捷** | 10 | 远程伤害、躲避 |
| **体质** | 10 | 生命值 |
| **智慧** | 10 | 议价成功率，谈判成功率 |
HP = 体质 × 10 + 力量 × 2；DEF = 体质 × 3 + 力量 × 1
```
- 数据层由 CockroachDB 承载，Go 侧已规划 `player_character`、`character_attribute`、`caravan`、`trade_good` 等表/结构体。  
```33:200:nakama/01-需求分析-tmp/003-数据结构设计.md
type PlayerCharacter struct {
    CharacterID uuid.UUID
    UserID uuid.UUID
    ...
}
type Caravan struct {
    CaravanID uuid.UUID
    CharacterID uuid.UUID
    ...
}
```
- 目标：给 Unreal Engine（蓝图）客户端与 Nakama 后端一个可执行的功能拆分与接口清单，确保后续模块开发、联调与自动化测试有据可依。

## 2. 功能拆分

| 模块 | 客户端职责（UE 蓝图） | 服务端职责（Go/Nakama） |
| --- | --- | --- |
| 账号/角色 | 角色创建 UI、校验、展示声望与属性、换装展示 | 校验命名、出身与属性初值写入 `player_character`/`character_attribute`，计算派生数值、返回配置 |
| 技能与装备 | 技能树可视化、升级按钮、装备穿戴表现 | 读取 `skill_definition`、`item_template`，更新 `character_skill`、`character_item`，处理冷却与耐久 |
| 商队/跑商 | 线路规划、自动寻路开关、货仓 UI、交易确认 | 维护 `caravan` 状态机、根据 `trade_node_stock` 与价格模型刷新报价、结算货物/风险 |
| 战斗 | 阵型选择、战斗回合可视化、战术按钮 | 驱动遭遇、计算先攻、技能效果、日志写入 `battle_action_log`，下发战斗结果 |
| 招募/事件 | NPC 对话 UI、雇佣确认、事件提示 | 管理 `crew_member`、生成随机事件（迷路、打劫）、推送通知 |

## 3. 客户端到服务端通道
- **认证**：客户端使用 Nakama 标准会话（Device/Email/Login）。会话 token 绑定用户，角色 ID 从 `storage`/RPC 返回。
- **调用方式**：
  - **HTTP/gRPC RPC**：蓝图通过 Nakama UE SDK 调用 `rpc_*` 方法；适合 CRUD、状态切换。
  - **Realtime Socket**：用于推送战斗行动、市场刷新、事件通知，频道命名 `rt.<module>.<character_id>`。
- **序列化**：全部使用 JSON，字段命名与数据库 `snake_case` 对齐（便于直接映射 Go 结构体）。

## 4. RPC 接口一览

| 模块 | RPC 名称（建议） | 方向 | 请求关键字段 | 响应关键字段 | 说明 |
| --- | --- | --- | --- | --- | --- |
| 角色 | `rpc_create_character` | 客户端→服务器 | `name`, `gender`, `background_id` | `player_character`, `character_attribute` | 一次性调用，服务端负责敏感词、重名校验与初始装备发放 |
|  | `rpc_get_character_profile` | C→S | `character_id` | 角色档案、队伍、装备摘要 | 进入游戏/角色面板时获取 |
|  | `rpc_set_loadout` | C→S | `character_id`, `equipment_ids` | 更新后的装备、派生属性 | 校验槽位和品质限制 |
| 技能 | `rpc_upgrade_skill` | C→S | `character_id`, `skill_id`, `use_item` | 新等级、冷却、资源扣减 | 校验技能点/货币 |
|  | `rpc_trigger_skill` | C→S | `encounter_id`, `skill_id`, `targets` | 行动结果片段 | 战斗中使用，写入日志 |
| 商队 | `rpc_sync_caravan` | C→S | `character_id` | `caravan`, `crew_members`, 当前货物 | 客户端初始化商队界面 |
|  | `rpc_set_auto_nav` | C→S | `caravan_id`, `route`, `enabled` | 新 `auto_nav` 状态、ETA | 控制 A 键自动寻路 |
|  | `rpc_start_travel` | C→S | `caravan_id`, `origin_node`, `target_node`, `formation_code` | 行程 ID、预计时间、风险 | 切换状态为 traveling |
|  | `rpc_finish_travel` | C→S | `caravan_id`, `travel_log` | 抵达节点、事件摘要 | 客户端在无遭遇时调用以确认 |
| 贸易 | `rpc_get_trade_quotes` | C→S | `node_id`, `character_id` | 商品列表、售价/收购价、配额 | 结合 `trade_node_stock` & 价格模型 |
|  | `rpc_execute_trade` | C→S | `caravan_id`, `node_id`, `orders[]` | 更新后货仓、资金、配额 | 支持买卖混合订单 |
|  | `rpc_fetch_price_snapshots` | C→S | `node_ids`, `since` | `market_price_snapshot[]` | 客户端图表/历史用途 |
| 队伍 | `rpc_recruit_crew_member` | C→S | `character_id`, `npc_id` | 新 `crew_member`，扣费结果 | 招募点交互 |
|  | `rpc_update_crew_status` | C→S | `crew_member_id`, `status`, `morale_delta`, `wage_paid` | 更新后的成员状态与士气 | 处理伤病、外出任务、工资结算 |
|  | `rpc_fire_crew_member` | C→S | `crew_member_id`, `reason` | 最新队伍清单 | 解雇/替换队员，回收槽位 |
| 战斗 | `rpc_preview_encounter` | C→S | `caravan_id`, `route_segment_code` | 敌人类型、推荐阵型 | 自动寻路前评估 |
|  | `rpc_start_battle` | C→S | `caravan_id`, `enemy_group_code` | `battle_encounter`, 先攻顺序 | 由系统或客户端触发 |
|  | `rpc_submit_turn` | C→S | `encounter_id`, `actions[]` | 回合结果、角色状态 | 一回合内所有己方行动 |
|  | `rpc_issue_tactic` | C→S | `encounter_id`, `tactic_code`, `targets` | tactic 结果、冷却剩余 | 对应集中火力/掩护撤退/威吓/呼叫支援 |
|  | `rpc_get_tactic_cooldowns` | C→S | `encounter_id` | 各战术剩余冷却、可用条件 | UI 展示战术按钮状态 |
|  | `rpc_finish_battle` | C→S | `encounter_id`, `tactic_code`, `escape` | 战果、掉落、伤害统计 | 结算后写日志 |
| 战役/多队 | `rpc_dispatch_squad` | C→S | `character_id`, `squad_payload`, `target_node` | 调度结果、行军路线 | 大地图多队调度、包围 |
|  | `rpc_update_campaign_state` | C→S | `campaign_id`, `action`, `payload` | 最新大地图局势、建筑耐久 | 包含攻城阶段进度 |
|  | `rpc_attack_structure` | C→S | `campaign_id`, `structure_code`, `damage_payload` | 建筑耐久、被干扰状态 | 对寨门/大殿造成持续伤害 |
| 商路风险/事件 | `rpc_get_route_status` | C→S | `route_segment_code`, `character_id` | 当前风险值、事件加成、可用支援 | UI 展示自动寻路风险 |
|  | `rpc_mark_route_event` | C→S | `route_segment_code`, `event_code`, `result` | 更新后的风险、奖励 | 如扫荡云中寨、建商栈 |
|  | `rpc_request_support` | C→S | `route_segment_code`, `caravan_id` | 支援是否可用、到达时间 | 满足条件时降低被抢率 |
| 事件 | `rpc_ack_event` | C→S | `character_id`, `event_id` | 新状态、奖励/惩罚 | 迷路、突发任务、推送确认 |

> **实现提示**：所有 RPC 都由 `nakama` Go 模块注册，例如 `nk.RegisterRpc("rpc_create_character", handlerCreateCharacter)`，在 handler 内读取/写入 CockroachDB，并返回 JSON。

## 5. 请求 / 响应草案

### 5.1 创建角色
**Request**
```json
{
  "name": "苏明远",
  "gender": "male",
  "background_id": 1,
  "appearance": "standard",
  "client_seed": "abc123"
}
```
**Response**
```json
{
  "player_character": {
    "character_id": "uuid",
    "name": "苏明远",
    "faction_id": 1,
    "reputation_level": 0
  },
  "attributes": {
    "strength": 8,
    "agility": 8,
    "constitution": 9,
    "wisdom": 15,
    "hp_max": 106,
    "defense": 13
  },
  "starting_items": [
    {"slot_code": "torso", "item_template_code": "麻布短褐"},
    {"slot_code": "weapon", "item_template_code": "青竹手杖"}
  ],
  "crew": [
    {"role_code": "accountant", "name": "苏明远", "skill_payload": {"精准记账": 1}}
  ]
}
```

### 5.2 获取贸易报价
**Request**
```json
{
  "character_id": "uuid-char",
  "node_id": "uuid-node",
  "force_refresh": false
}
```
**Response**
```json
{
  "node": {
    "node_id": "uuid-node",
    "code": "TAIYUAN_CITY",
    "development_level": 3
  },
  "goods": [
    {
      "trade_good_id": 101,
      "code": "WHEAT",
      "sale_price": 60,
      "purchase_price": 52,
      "quota_remaining": 120,
      "demand_shock": 1.05,
      "supply_shock": 0.95
    }
  ],
  "next_refresh_at": "2025-12-03T08:15:00Z"
}
```

### 5.3 战斗回合提交
**Request**
```json
{
  "encounter_id": "uuid-enc",
  "turn_number": 3,
  "actions": [
    {"actor_ref": "guard#1", "action_type": "skill", "skill_id": 12, "target_ref": "bandit#boss"},
    {"actor_ref": "doctor#1", "action_type": "skill", "skill_id": 25, "target_ref": "player"}
  ]
}
```
**Response**
```json
{
  "turn_number": 3,
  "action_logs": [
    {"actor_ref": "guard#1", "damage": 42, "stun": true},
    {"actor_ref": "bandit#boss", "status": "stunned"}
  ],
  "player_party": {"hp": {"player": 90, "guard#1": 75}},
  "enemy_party": {"hp": {"bandit#boss": 30}},
  "battle_status": "active"
}
```

### 5.4 战术指令（集中火力 / 掩护撤退 / 威吓 / 支援）
**Request**
```json
{
  "encounter_id": "uuid-enc",
  "tactic_code": "FOCUS_FIRE",
  "targets": ["bandit#boss"],
  "client_tx_id": "tx-7788"
}
```
**Response**
```json
{
  "tactic_code": "FOCUS_FIRE",
  "result": {
    "forced_target": "bandit#boss",
    "ally_bonus": {"damage_pct": 0.1}
  },
  "cooldowns": {
    "FOCUS_FIRE": 2,
    "WITHDRAW": 3,
    "INTIMIDATE": 1,
    "CALL_SUPPORT": 0
  }
}
```

### 5.5 商路风险与支援
**Request**
```json
{
  "route_segment_code": "SHILING_YANMEN",
  "character_id": "uuid-char",
  "force_refresh": true
}
```
**Response**
```json
{
  "route_segment_code": "SHILING_YANMEN",
  "base_risk": 0.3,
  "modifiers": [
    {"source": "CLOUD_FORTRESS_SWEEP", "delta": -0.25},
    {"source": "WEATHER", "delta": +0.05}
  ],
  "support_available": true,
  "support_eta_secs": 120,
  "next_review_at": "2025-12-03T08:30:00Z"
}
```

### 5.6 多队战役调度
**Request**
```json
{
  "campaign_id": "uuid-campaign",
  "squad_name": "先锋队",
  "members": ["guard#1", "porter#2", "doctor#1"],
  "target_node": "YUNZHONG_STRONGHOLD_GATE",
  "orders": ["advance", "hold"]
}
```
**Response**
```json
{
  "campaign_id": "uuid-campaign",
  "squad_id": "uuid-squad",
  "path": ["TAIYUAN_CITY", "SHILING_PASS", "YUNZHONG_STRONGHOLD_GATE"],
  "eta_secs": 480,
  "current_phase": "march",
  "structure_status": {
    "gate": {"hp": 850, "status": "under_attack"},
    "hall": {"hp": 1200, "status": "idle"}
  }
}
```

## 6. 推送/实时频道
- `rt.battle.<encounter_id>`：战斗状态增量（敌方行动、状态结算、战术冷却）。
- `rt.market.<node_code>`：贸易点价格刷新广播（含 `snapshot_id`）。
- `rt.travel.<caravan_id>`：自动寻路进度、途中事件、风险提示。
- `rt.event.<character_id>`：迷路、突发任务、支援到达等消息，需要客户端调用 `rpc_ack_event` 反馈。
- `rt.route.<segment_code>`：商路风险、扫荡状态、支援抵达广播。
- `rt.campaign.<campaign_id>`：多队战役中每个阶段的进度、建筑耐久、敌军增援提醒。
- `presence`：用于展示商队在大地图上的可见性（共享位置/阵型）。

## 7. 状态管理与一致性
- **幂等**：旅行、交易等操作带 `client_tx_id`，服务端保存最近若干事务 ID，防止断线重试导致二次扣费。
- **锁定策略**：战斗、战术、交易及风险修改写入时使用 `SELECT ... FOR UPDATE` 或 Nakama Storage 的乐观版本号，避免重复消费配额/多次触发战术。
- **冷却/定时**：服务端统一计算技能冷却与价格刷新；客户端只展示倒计时。
- **战术冷却/全局事件**：`rpc_get_tactic_cooldowns` 与 `rt.campaign` 推送共享同一冷却源，保证多端同步。
- **商路风险日志**：路线风险、支援调用记录写入 `route_risk_log`（可追加到数据结构设计中），便于溯源。

## 8. 实施节奏建议
1. **基础 RPC**：先实现 `rpc_create_character`、`rpc_get_character_profile`、`rpc_sync_caravan`，打通登录→角色→商队界面最小流程。
2. **贸易闭环**：实现 `rpc_get_trade_quotes`、`rpc_execute_trade`，并结合 `market_price_snapshot` 定时刷新作业。
3. **战斗闭环**：补齐 `rpc_start_battle`、`rpc_submit_turn`、`rpc_issue_tactic` 及实时频道推送。
4. **高级功能**：自动寻路、阵型/战术、战役调度、商路风险事件、价格图表、多人协作。
5. **监控与调试**：为每个 RPC 记录 Prometheus 指标（延迟、错误率），并在 Nakama Runtime 中开启结构化日志，方便定位。

---
本稿提供了最小可行接口与数据契约，后续若扩展更多系统（如多队战役、建筑攻防）可复用同一模式：配置 → RPC → 实时推送 → 日志。

