### 角色与职业系统（@09-需求设计）

- **角色（PlayerCharacter）**
  - **基础信息**
    - `name`：姓名（中/英文长度规则、敏感词过滤、重名检测）
    - `gender`：性别（影响外观、时装、称号）
    - `appearance`：外貌预设
      - `body_type`：体型（标准型 / 健壮型）
      - `face_preset`：脸型（暂 1–2 组）
    - `outfit_preset`：初始服饰
      - `top`：上衣
      - `bottom`：下装
      - `shoes`：鞋子
      - `head_accessory`：头部装饰
      - `weapon_skin`：武器外观
  - **势力与出身**
    - `faction`：势力（Demo：晋商，出生地太原府）
    - `background`：出身背景
      - 候选：`落榜秀才` / `镖局趟子手` / `牙行牙侩`
      - `initial_attribute_bias`：属性倾向
      - `initial_team_member`：初始团队成员（账房 / 护卫 / 脚夫）

- **身份表征（Identity & Reputation）**
  - `faction_reputation_level`：势力声望等级
    - 阶段：无名 → 知名 → 尊敬 → 崇敬 → 传奇
  - `faction_badge`：势力专属标识 icon

- **核心属性（CoreAttributes）**
  - `str`（力量）：影响近战伤害、防御
  - `agi`（敏捷）：影响远程伤害、躲避
  - `vit`（体质）：影响生命值
  - `int`（智慧）：影响议价成功率、谈判成功率
  - **基础公式**
    - `HP = vit × 10 + str × 2`
    - `DEF = vit × 3 + str × 1`（另有示例：`DEF = vit + floor(str/2)`）
    - `melee_damage = base + str × 1 + weapon_damage`
    - `ranged_damage = base + agi × 1`
  - **出身初始属性模板**
    - `落榜秀才`：str 8, agi 8, vit 9, int 15
    - `镖局趟子手`：str 14, agi 9, vit 13, int 4
    - `牙行牙侩`：str 9, agi 14, vit 8, int 9

- **技能树（SkillTree）**
  - **商贾之道（TradePath）**
    - `识货`（被动）
      - 效果：提升购买量  
      - 公式：`buy_amount_bonus% = 3% + int × 0.2%`
    - `议价`（主动）
      - 效果：影响买入/卖出价  
      - 公式：`price_delta% = int × 0.1% + skill_level × 0.5%`
    - `打探`（被动）
      - 效果：从 NPC 获取情报  
      - 公式：`success_rate% = 15% + int × 1% + skill_level × 3%`
  - **防卫之术（CombatPath）**
    - `攻击`（普攻·主动）
      - 冷却：无  
      - 伤害：`40 + str × 1 + weapon_damage`
    - `重劈`（高伤单体·主动）
      - 冷却：Lv0–2:3 / Lv3–6:2 / Lv7–10:1 回合  
      - 伤害：`(40 + str × 1) × (1.0 + skill_level × 0.1)`
      - 额外：击晕概率 `= 10% + skill_level × 2%`
    - `破甲`（减防·主动）
      - 伤害：`(40 + str × 1) × 0.9`
      - `def_down = 8 + skill_level × 2`，持续 3 回合
      - 冷却：Lv0–3:4 / Lv4–7:3 / Lv8–10:2 回合
    - `包扎`（治疗·主动）
      - 治疗：`15 + skill_level × 2`
      - 效果：清除【流血】
      - 冷却：无（或在团队 AI 版本中：`20 + 品阶系数 × 智慧`）
    - `治疗`（治疗·主动）
      - 治疗：`30 + skill_level × 4`（团队 AI 版本：`40 + 品阶系数 × 智慧`）
      - 消耗：1 份金疮药
      - 冷却：3 回合
    - `手术`（高级治疗·主动，仅传说品阶）
      - 治疗：`50 + skill_level × 5`（团队 AI：`60 + 品阶系数 × 智慧`）
      - 额外：若目标 HP < 30%，再恢复缺失 HP 的 30%
      - 消耗：1 个麻沸散
      - 冷却：5 回合

- **装备系统（Equipment）**
  - **装备位（Slots）**
    - `top`：上衣（加 vit、str）
    - `bottom`：下装（加 vit、agi）
    - `shoes`：鞋子（加 agi）
    - `head`：头饰（加 int）
    - `weapon`：武器（属性加成 + 伤害）
  - **品质（Quality）**
    - 普通（白）：+1~2 主属性
    - 精良（绿）：+2~3
    - 优质（蓝）：+3~4
    - 稀有（紫）：+4~6
    - 传说（橙）：+6~8 + 特效
  - **初始绑定装备（Demo）**
    - `麻布短褐`（上衣）：+1 vit
    - `棉布裈裤`（下装）：+1 agi
    - `编草鞋`（鞋）：+1 agi
    - `青布头巾`（头饰）：+1 int
  - **初始武器**
    - 落榜秀才：`青竹手杖`（+2 int，+2 伤害）
    - 镖局趟子手：`熟铁短刀`（+2 str，+4 伤害）
    - 牙行学徒：`黄杨算盘`（+2 int，+2 伤害）

- **团队系统（CaravanTeam）**
  - **团队职业（TeamRoles）**
    - 护卫：核心职能=防御劫掠  
      - 基础技能：`警戒巡逻`（被抢概率 -5%）
    - 账房：议价集采  
      - 技能：`精准记账`（采购成本 -5%）
    - 郎中：治疗伤病  
      - 技能：`草药救治`（解除伤病）
    - 向导：适配地形  
      - 技能：`地形辨识`（迷路概率 -5%）
    - 脚夫：承载货物  
      - 技能：`重物搬运`（载货量 +5%）
    - 货匠：货物保管  
      - 技能：`货物保管`（损坏事件概率 -5%）
  - **成员属性（TeamMember）**
    - 字段：`role_type` / `name` / `background_desc` / `str` / `agi` / `vit` / `int`
    - 品质：`quality_coeff`（普通 0.5 / 优质 1.0 / 传说 1.2）
  - **招募流程**
    - 招募点：`酒馆` / `驿站`
    - 对话：自我介绍 → 报酬 → 判断银两是否足够
    - 结果：
      - 成功：扣除银两，加入商队
      - 失败：提示银两不足

---

### 战斗系统

- **战斗单位（CombatUnit）**
  - 玩家主角
  - 团队成员：护卫 / 账房 / 郎中 / 向导 / 脚夫 / 货匠
  - 敌人：流民 / 山匪 / 山匪头目 / 马贼
  - 属性：
    - `str` / `agi` / `vit` / `int`
    - `HP` / `DEF`
    - `weapon_damage`
    - 状态：`bleeding` / `poisoned` / `stunned` / `armor_broken` 等

- **团队战斗角色定位**
  - 护卫：主力输出，可用 `重劈`
    - 伤害：`40 + str × 1 + weapon`
  - 账房：自保反击，仅普攻
    - 伤害：`20 + str × 0.8 + weapon`
  - 郎中：专注治疗，可用【治疗/包扎/手术】
    - 伤害：`18 + str × 0.7 + weapon`
  - 向导：观察预警，仅普攻
    - 伤害：`30 + str × 0.9 + weapon`
  - 脚夫：负重硬扛，仅普攻
    - 伤害：`30 + str × 0.8 + weapon`
  - 货匠：工具防身，仅普攻
    - 伤害：`18 + str × 0.7 + weapon`

- **治疗 AI（HealerAI）**
  - 条件优先级：
    - 若有队友 HP < 50% → 尝试 `治疗`（冷却好）
    - 若有人流血/中毒 → 优先 `包扎`
    - 若有人濒死（HP < 20%）且有手术技能 → 尝试 `手术`
  - 技能效果（团队版本）：
    - `包扎`：治疗 `20 + quality_coeff × int`，清除流血
    - `治疗`：治疗 `40 + quality_coeff × int`，消耗 1 金疮药
    - `手术`：治疗 `60 + quality_coeff × int`，HP<30% 额外恢复 30% 缺失 HP，消耗麻沸散

- **阵型（Formation）**
  - `鱼鳞阵（进攻）`：全队伤害 +10%，DEF -5
  - `方圆阵（防御）`：全队 DEF +10
  - `雁行阵（机动）`：敏捷 +5，先手率提升

- **核心战斗流程（BattleRoundFlow）**
  - 阶段 1：速度判定
    - `speed = agi × 0.8 + shoes_bonus + random(-2~+2)`
    - 敌我混排，按 speed 排序
  - 阶段 2：行动选择
    - 动作：
      - 普通攻击
      - 技能（重劈 / 破甲 / 治疗 / 包扎 / 手术）
      - 使用道具（金疮药 / 烟雾弹）
      - 战术指令（全队级）
  - 阶段 3：状态结算
    - DOT（流血/中毒）伤害
    - 破甲剩余回合递减
    - 击晕单位跳过下回合

- **命中与伤害（Hit & Damage）**
  - 命中率：
    - `hit_rate = 50% + (attacker_agi - defender_agi) × 0.5%`
    - 范围：30% ~ 80%
  - 实际伤害：
    - `damage = max(3, (40 + str + weapon_damage) - enemy_DEF)`
  - 特效触发：
    - 先判命中 → 再按概率触发特效（如重劈击晕）

- **战术指令（Tactics，全队级）**
  - `集中火力`：当回合全队攻击同一目标，CD=2 回合
  - `掩护撤退`：下回合逃跑成功率 +30%，CD=3
  - `威吓震慑`：智慧检定，可能让 1 名弱敌逃跑，CD=3
  - `呼叫支援`：在本势力有商栈的路段，可呼叫 NPC 护卫支援（一次战斗限定）

- **敌人与敌方队伍（Enemies & Groups）**
  - 敌人属性模板：
    - 流民：str 8, vit 9, agi 10, HP 106, DEF 30, dmg 48
    - 山匪：str 12, vit 11, agi 10, HP 134, DEF 35, dmg 54(+2 刀)
    - 山匪头目：str 14, vit 12, agi 11, HP 148, DEF 40, dmg 58(+4 刀)
    - 马贼：str 11, vit 10, agi 14, HP 122, DEF 40, dmg 54(+3 刀)
  - 敌方团伙（Group）
    - `流民团伙`：3×流民，AI：集火 HP 最低者，克制无护卫商队
    - `山匪小队`：1 头目 + 2 山匪，AI：头目集火主角，小兵围攻雇员
    - `马贼突袭队`：2 马贼，AI：首回合必先手，优先击杀向导/账房

- **多团队战役（大地图 + 小队战斗）**
  - 大地图阶段（即时/战棋）：
    - 对象：`BattleMapTeam`（多支队伍）、建筑（城门/大殿）、临时路障等
    - 操作：移动、集结、战场技能
  - 小队战斗阶段（回合制）：
    - 触发条件：队伍攻击另一支队伍
    - 独立战斗场景，战后返回大地图，败方可能被击退
  - 建筑攻击阶段（即时结算）：
    - 目标为建筑时：自动持续伤害建筑耐久
    - 若中途被敌队攻击则中断，进入小队战斗
  - 胜负判定：
    - 扫荡山寨：击杀 BOSS
    - 贸易点争夺：夺旗成功；失败则守方胜利

---

### 跑商系统（概要，只列出主要对象）

- **商品品类（GoodsCategory）**
  - 字段：`name`、`sample_goods`、`type`（普通 / 高价值 / 专营 / 商帮专属等）
  - 示例：米粮 / 杂食 / 布帛 / 皮货 / 铁器 / 木器 / 瓷器 / 漆器 / 药材 / 酒 / 调料 / 杂货 / 茶 / 香料 / 番货 / 盐 …

- **商品（GoodItem）**
  - `category`：所属品类
  - `name`：商品名
  - `base_price`：基准价
  - `rarity`：稀有度（普通=1，稀有=0.5，珍贵=0.2）
  - 备注/星级说明

- **价格模型变量（PriceModel）**
  - `BasePrice`
  - `D`：城市综合发展度
  - `D_local`：本地偏好度
  - `R`：玩家声望等级
  - `Rarity`：商品稀有度
  - `DemandShock` / `SupplyShock`
  - `GlobalFactor`：全局供需系数
  - `Tax_Markup`：税差 / 利润率
  - `k_d` / `k_d_local` / `k_r` / `k_q`：影响系数
  - 推导变量：
    - `H_D`（价格基准系数）
    - `SalePrice` / `PurchasePrice`
    - `AvailableQuota`（配额）

- **载具（Vehicle）**
  - Demo：初始马队
    - `horses_count`：5
    - `capacity_per_horse`：10
    - `total_capacity`：50
    - `damage_probability`：10%
    - `speed`：20 / 分钟（游戏 1 分钟 = 现实 1 天）

- **贸易点 / 城市与路线（TradePoint & Route）**
  - 城市：太原府 / 大同 等
  - 中间地标：石岭关 / 雁门关 / 云中寨 / 商栈
  - 距离：
    - 太原府–石岭关：10
    - 石岭关–雁门关：20
    - 雁门关–大同府：25
  - 风险配置（按路段）：
    - 风险系数，敌人团伙构成及概率
    - 扫荡山寨 / 建立商栈后风险变化（时间维持）

- **操作与交互（Operations）**
  - 移动与视角：移动 / 视角旋转 / 缩放 / 重置
  - 跑商专用：设定自动寻路目标、启动/停止自动寻路

这棵树可以直接当成你后端建模和存储结构的参考；如果你需要，我可以在此基础上再帮你映射一份“后端存储 schema 草案”（每个对象映射到 Nakama Storage 的 collection/key/value 结构）。




